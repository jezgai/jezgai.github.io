<!--
   imagen.html
   
   Copyright 2019 Jose Luis Jiménez Marín <joseluis@Gran-Zenon>
   
   This program is free software; you can redistribute it and/or modify
   it under the terms of the GNU General Public License as published by
   the Free Software Foundation; either version 2 of the License, or
   (at your option) any later version.
   
   This program is distributed in the hope that it will be useful,
   but WITHOUT ANY WARRANTY; without even the implied warranty of
   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
   GNU General Public License for more details.
   
   You should have received a copy of the GNU General Public License
   along with this program; if not, write to the Free Software
   Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston,
   MA 02110-1451, USA.
   
   
-->

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
	"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">

	<head>
		<title>Testing canvas</title>
		<meta http-equiv="content-type" content="text/html;charset=utf-8" />
		<meta name="generator" content="Geany 1.32" />
		<style>
			body {
				background: #333:
			}
			#main {
				margin-top: 0px;
				text-align: left;
			}
			#canvas {
				background-color: #000;
				height: 1240 px;
				width: 875 px;
			}
		</style>
		<script src="javascript/FileSaver.js"></script>
		<script>
			let nombrePJ = "PJ-VE Salvaje Oeste";
		</script>
	</head>

	<body onload="cargaPersonaje()" >
			<div id="main">
				<canvas id="canvas" width="875" height="1240"></canvas>
			</div>
			<script>
				var app = ( function() {
					context = canvas.getContext( '2d' ),
					
					// API
					public = {};
					
					// Public methods goes here ...
					public.loadPicture = function(personaje) {
						var imageObj = new Image();
						imageObj.src = 'VE-E-F1.jpg';
						imageObj.onload = function () {
							context.drawImage( imageObj, 0, 0);
							context.font = "12pt bold Arial";
							if (typeof personaje.nombre !== 'undefined') {
								context.fillText(personaje.nombre, 405, 63);
								nombrePJ = personaje.nombre;
							}
							if (typeof personaje.clase !== 'undefined') {
								context.fillText(personaje.clase, 340, 99);
							}
							if (typeof personaje.nivel !== 'undefined') {
								context.fillText(personaje.nivel, 600, 99);
							}
							if (typeof personaje.mov !== 'undefined') {
								context.fillText(personaje.mov, 600, 135)
							}
							if (typeof personaje.trasfondo1 !== 'undefined') {
								context.fillText(personaje.trasfondo1, 421, 455);
							}
							if (typeof personaje.trasfondo2 !== 'undefined') {
								context.fillText(personaje.trasfondo2, 421, 480);
							}
							if (typeof personaje.trasfondo3 !== 'undefined') {
								context.fillText(personaje.trasfondo3, 421, 505);
							}
							if (typeof personaje.trasfondo4 !== 'undefined') {
								context.fillText(personaje.trasfondo4, 421, 530);
							}
							
							if (typeof personaje.talento1 !== 'undefined') {
								if ( personaje.talento1.length > 63 ) {
									context.font = "10pt bold Arial";
								}
								context.fillText(personaje.talento1, 545, 635);
								if ( personaje.talento1.length > 63 ) {
									context.font = "12pt bold Arial";
								}
							}
							if (typeof personaje.talento2 !== 'undefined') {
								if ( personaje.talento2.length > 63 ) {
									context.font = "10pt bold Arial";
								}
								context.fillText(personaje.talento2, 545, 660)
								if ( personaje.talento2.length > 63 ) {
									context.font = "12pt bold Arial";
								}
							}
							if (typeof personaje.talento3 !== 'undefined') {
								if ( personaje.talento3.length > 63 ) {
									context.font = "10pt bold Arial";
								}
								context.fillText(personaje.talento3, 545, 685)
								if ( personaje.talento3.length > 63 ) {
									context.font = "12pt bold Arial";
								}
							}
							if (typeof personaje.talento4 !== 'undefined') {
								if ( personaje.talento4.length > 63 ) {
									context.font = "10pt bold Arial";
								}
								context.fillText(personaje.talento4, 545, 710)
								if ( personaje.talento4.length > 63 ) {
									context.font = "12pt bold Arial";
								}
							}
							if (typeof personaje.dinero !== 'undefined') {
								context.fillText(personaje.dinero + " mo", 545, 950);
							}
							context.font = "18pt bold Arial";
							if (typeof personaje.fue !== 'undefined') {
								context.fillText(personaje.fue, 180, 225)
							}
							if (typeof personaje.mfue !== 'undefined') {
								context.fillText(personaje.mfue, 255, 225)
							}
							if (typeof personaje.des !== 'undefined') {
								context.fillText(personaje.des, 180, 290)
							}
							if (typeof personaje.mdes !== 'undefined') {
								context.fillText(personaje.mdes, 255, 290)
							}
							if (typeof personaje.con !== 'undefined') {
								context.fillText(personaje.con, 180, 355)
							}
							if (typeof personaje.mcon !== 'undefined') {
								context.fillText(personaje.mcon, 255, 355)
							}
							if (typeof personaje.int !== 'undefined') {
								context.fillText(personaje.int, 180, 418)
							}
							if (typeof personaje.mint !== 'undefined') {
								context.fillText(personaje.mint, 255, 418)
							}
							if (typeof personaje.sab !== 'undefined') {
								context.fillText(personaje.sab, 180, 482)
							}
							if (typeof personaje.msab !== 'undefined') {
								context.fillText(personaje.msab, 255, 482)
							}
							if (typeof personaje.car !== 'undefined') {
								context.fillText(personaje.car, 180, 548)
							}
							if (typeof personaje.mcar !== 'undefined') {
								context.fillText(personaje.mcar, 255, 548)
							}
							
							
							if (typeof personaje.ins !== 'undefined') {
								context.fillText(personaje.ins, 320, 225)
								context.fillText(personaje.ins, 320, 290)
								context.fillText(personaje.ins, 320, 355)
								context.fillText(personaje.ins, 320, 418)
								context.fillText(personaje.ins, 320, 482)
								context.fillText(personaje.ins, 320, 548)
							}
							
							if (typeof personaje.pvt !== 'undefined') {
								context.fillText(personaje.pvt, 490, 295)
							}
							if (typeof personaje.pva !== 'undefined') {
								context.fillText(personaje.pva, 555, 295)
							}
							if (typeof personaje.pod !== 'undefined') {
								context.fillText(personaje.pod, 490, 378)
							}
							
							if (typeof personaje.def !== 'undefined') {
								context.font = "28pt bold Arial";
								context.fillText(personaje.def, 720, 340)
								context.font = "18pt bold Arial";
							}
							if (typeof personaje.aler !== 'undefined') {
								context.fillText(personaje.aler, 335, 850)
							}
							if (typeof personaje.comu !== 'undefined') {
								context.fillText(personaje.comu, 335, 892)
							}
							if (typeof personaje.mani !== 'undefined') {
								context.fillText(personaje.mani, 335, 933)
							}
							if (typeof personaje.erud !== 'undefined') {
								context.fillText(personaje.erud, 335, 975)
							}
							if (typeof personaje.subt !== 'undefined') {
								context.fillText(personaje.subt, 335, 1019)
							}
							if (typeof personaje.supe !== 'undefined') {
								context.fillText(personaje.supe, 335, 1060)
							}
							
							
							if (typeof personaje.atq !== 'undefined') {
								context.fillText(personaje.atq, 250, 634)
							}
							

							if ( typeof personaje.foto !== 'undefined') {
								var imgpj = new Image();
								imgpj.src = personaje.foto;
								//imgpj.crossOrigin = "Anonymous";
								imgpj.onload = function () {
									var w = 175;
									var h = 180;
									if ( (parseFloat(this.width) / parseFloat(w)) > (parseFloat(this.height) / parseFloat(h)) ) {
										
										h =  (parseFloat(w) / parseFloat(this.width)) * parseFloat(this.height);
									}
									else {
										w =  (parseFloat(h) / parseFloat(this.height)) * parseFloat(this.width);
									}
									var posx = 648;
									var posy = 48;
									
									if ( w < 175 ) {
										posx = posx + ((175 - w) / 2)
									}
									if ( h < 180 ) {
										posy = posy + ((180 - h) / 2)
									}
									
									context.drawImage(imgpj, posx, posy, w, h);
								}
							}
							/*
							canvas.toBlob(function(blob) {
								saveAs(blob, nombrePJ + ".png");
							});	
							*/			
						}
						
						
					};
					
					public.getImgData = function () {
						return context.getImageData(0 , 0, canvas.width, canvas.height);
					};
					
					public.save = function () {
						var link = window.document.createElement( 'a' ),
							url = canvas.toDataURL(),
							filename = 'pj.png';
						link.setAttribute( 'href', url);
						link.setAttribute( 'download', filename);
						link.style.visibility = 'hidden';
						window.document.body.appendChild( link );
						link.click();
						window.document.body.removeChild( link );
					};
					return public;
				} () );
				
				
				function parse_query_string(query) {
				  var vars = query.split("&");
				  var query_string = {};
				  for (var i = 0; i < vars.length; i++) {
					var pair = vars[i].split("=");
					var key = decodeURIComponent(pair[0]);
					var value = decodeURIComponent(pair[1]);
					// If first entry with this name
					if (typeof query_string[key] === "undefined") {
					  query_string[key] = decodeURIComponent(value);
					  // If second entry with this name
					} else if (typeof query_string[key] === "string") {
					  var arr = [query_string[key], decodeURIComponent(value)];
					  query_string[key] = arr;
					  // If third or later entry with this name
					} else {
					  query_string[key].push(decodeURIComponent(value));
					}
				  }
				  return query_string;
				}
				
				function cargaPersonaje() {
					var query = window.location.search.substring(1);
					var pj = parse_query_string(query);
					app.loadPicture(pj);
				};
				
			</script>
	</body>

</html>
